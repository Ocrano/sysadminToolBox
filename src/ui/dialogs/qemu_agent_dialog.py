from PyQt6.QtCore import Qt, QThread, pyqtSignal
from PyQt6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout, QLabel, QPushButton, 
    QTableWidget, QTableWidgetItem, QProgressBar,
    QGroupBox, QInputDialog, QLineEdit, QMessageBox, QCheckBox,
    QFormLayout, QWidget
)
from PyQt6.QtGui import QIcon, QFont, QColor

# Import du syst√®me de logging
from ...core.logger import toolbox_logger, log_debug, log_info, log_error, log_success, log_step, log_vm

class SSHCredentialsDialog(QDialog):
    """Dialogue pour saisir les credentials SSH"""
    def __init__(self, parent=None, vm_info=None):
        super().__init__(parent)
        self.vm_info = vm_info
        self.credentials = {}
        self.init_ui()

    def init_ui(self):
        self.setWindowTitle("Credentials SSH requis")
        self.setModal(True)
        self.resize(400, 300)
        
        layout = QVBoxLayout()
        
        # Header
        vm_name = self.vm_info.get('name', 'VM inconnue') if self.vm_info else 'VM'
        header_label = QLabel(f"üîê Credentials SSH pour {vm_name}")
        header_label.setStyleSheet("font-size: 14px; font-weight: bold; margin-bottom: 10px;")
        layout.addWidget(header_label)
        
        desc_label = QLabel("Entrez les informations de connexion SSH pour installer QEMU Agent :")
        desc_label.setStyleSheet("color: #6c757d; margin-bottom: 15px;")
        desc_label.setWordWrap(True)
        layout.addWidget(desc_label)
        
        # Formulaire
        form_group = QGroupBox("Informations de connexion")
        form_layout = QFormLayout()
        
        # IP (pr√©-remplie si disponible)
        self.ip_input = QLineEdit()
        if self.vm_info and self.vm_info.get('ip') not in ['Non disponible', 'IP non disponible']:
            self.ip_input.setText(self.vm_info.get('ip', ''))
        self.ip_input.setPlaceholderText("Ex: 192.168.1.100")
        form_layout.addRow("üåê Adresse IP:", self.ip_input)
        
        # Utilisateur
        self.username_input = QLineEdit()
        self.username_input.setPlaceholderText("Ex: root, admin, ubuntu...")
        form_layout.addRow("üë§ Nom d'utilisateur:", self.username_input)
        
        # Mot de passe
        self.password_input = QLineEdit()
        self.password_input.setEchoMode(QLineEdit.EchoMode.Password)
        self.password_input.setPlaceholderText("Mot de passe SSH")
        form_layout.addRow("üîë Mot de passe:", self.password_input)
        
        # Checkbox pour afficher le mot de passe
        self.show_password_checkbox = QCheckBox("Afficher le mot de passe")
        self.show_password_checkbox.toggled.connect(self.toggle_password_visibility)
        form_layout.addRow("", self.show_password_checkbox)
        
        form_group.setLayout(form_layout)
        layout.addWidget(form_group)
        
        # Notes
        notes_group = QGroupBox("‚ÑπÔ∏è Informations")
        notes_layout = QVBoxLayout()
        notes_text = QLabel("""
‚Ä¢ L'installation n√©cessite les privil√®ges sudo/root
‚Ä¢ Les commandes suivantes seront ex√©cut√©es :
  - Installation du package qemu-guest-agent
  - Activation et d√©marrage du service
‚Ä¢ La connexion SSH doit √™tre accessible depuis ce poste
‚Ä¢ Un red√©marrage complet de la VM sera effectu√©
‚Ä¢ Les logs d√©taill√©s s'affichent dans l'onglet Export Projet
        """.strip())
        notes_text.setStyleSheet("font-size: 11px; color: #6c757d;")
        notes_text.setWordWrap(True)
        notes_layout.addWidget(notes_text)
        notes_group.setLayout(notes_layout)
        layout.addWidget(notes_group)
        
        # Boutons
        button_layout = QHBoxLayout()
        
        self.cancel_button = QPushButton("‚ùå Annuler")
        self.cancel_button.clicked.connect(self.reject)
        button_layout.addWidget(self.cancel_button)
        
        button_layout.addStretch()
        
        self.ok_button = QPushButton("‚úÖ Continuer l'installation")
        self.ok_button.clicked.connect(self.accept_credentials)
        self.ok_button.setDefault(True)
        self.ok_button.setStyleSheet("""
            QPushButton {
                background-color: #28a745;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #218838;
            }
        """)
        button_layout.addWidget(self.ok_button)
        
        layout.addLayout(button_layout)
        self.setLayout(layout)
        
        # Focus sur le premier champ vide
        if not self.ip_input.text():
            self.ip_input.setFocus()
        else:
            self.username_input.setFocus()

    def toggle_password_visibility(self, checked):
        """Bascule la visibilit√© du mot de passe"""
        if checked:
            self.password_input.setEchoMode(QLineEdit.EchoMode.Normal)
        else:
            self.password_input.setEchoMode(QLineEdit.EchoMode.Password)

    def accept_credentials(self):
        """Valide et accepte les credentials"""
        ip = self.ip_input.text().strip()
        username = self.username_input.text().strip()
        password = self.password_input.text().strip()
        
        # Validation
        if not ip:
            QMessageBox.warning(self, "Champ requis", "L'adresse IP est requise")
            self.ip_input.setFocus()
            return
        
        if not username:
            QMessageBox.warning(self, "Champ requis", "Le nom d'utilisateur est requis")
            self.username_input.setFocus()
            return
        
        if not password:
            QMessageBox.warning(self, "Champ requis", "Le mot de passe est requis")
            self.password_input.setFocus()
            return
        
        # Validation de l'IP
        try:
            import ipaddress
            ipaddress.IPv4Address(ip)
        except Exception:
            QMessageBox.warning(self, "IP invalide", "L'adresse IP n'est pas valide")
            self.ip_input.setFocus()
            return
        
        # Stocker les credentials
        self.credentials = {
            'ip': ip,
            'username': username,
            'password': password
        }
        
        log_debug(f"Credentials SSH valid√©s pour {username}@{ip}", "QemuAgent")
        self.accept()

    def get_credentials(self):
        """Retourne les credentials saisis"""
        return self.credentials

class QemuAgentInstallThread(QThread):
    """Thread pour installer QEMU Agent - Version avec logging complet"""
    progress_update = pyqtSignal(str)
    installation_complete = pyqtSignal(bool, str, dict)  # success, message, vm_info
    
    def __init__(self, proxmox_handler, vm_info, ssh_credentials=None, auto_restart=False):
        super().__init__()
        self.proxmox_handler = proxmox_handler
        self.vm_info = vm_info
        self.ssh_credentials = ssh_credentials
        self.auto_restart = auto_restart
        self.restart_confirmed = False
    
    def run(self):
        vm_name = self.vm_info.get('name', 'VM inconnue')
        log_vm("D√©but thread d'installation QEMU Agent", vm_name)
        
        try:
            if self.vm_info['os_type'] == 'linux':
                if not self.ssh_credentials:
                    log_error("Credentials SSH manquants", "Installation")
                    self.installation_complete.emit(False, "Credentials SSH requis pour Linux", self.vm_info)
                    return
                
                log_step(1, 5, "D√©marrage installation QEMU Agent", "Installation")
                
                # Utiliser la version simplifi√©e sans dialogue dans le thread
                success, message = self.install_qemu_agent_simple_sequence(
                    self.vm_info, 
                    self.ssh_credentials
                )
                
                if success:
                    log_success(f"Installation termin√©e: {message}", "Installation")
                    self.installation_complete.emit(True, message, self.vm_info)
                else:
                    log_error(f"Installation √©chou√©e: {message}", "Installation")
                    self.installation_complete.emit(False, message, self.vm_info)
                    
            elif self.vm_info['os_type'] == 'windows':
                log_info("VM Windows d√©tect√©e - installation manuelle requise", "Installation")
                success, message = self.proxmox_handler.install_qemu_agent_windows(self.vm_info)
                self.installation_complete.emit(False, message, self.vm_info)
            else:
                log_error(f"OS non support√©: {self.vm_info['os_type']}", "Installation")
                self.installation_complete.emit(False, f"OS non support√© pour {vm_name}", self.vm_info)
                
        except Exception as e:
            log_error(f"Erreur inattendue dans le thread: {str(e)}", "Installation")
            self.installation_complete.emit(False, f"Erreur inattendue: {str(e)}", self.vm_info)
    
    def install_qemu_agent_simple_sequence(self, vm_info, ssh_credentials):
        """Version simplifi√©e de l'installation sans dialogues PyQt avec logging d√©taill√©"""
        vm_name = vm_info.get('name', 'VM inconnue')
        node_name = vm_info.get('node')
        vmid = vm_info.get('vmid')
        
        log_vm("D√©but s√©quence d'installation compl√®te", vm_name)
        
        try:
            import time
            
            # √âTAPE 1: Installation du package
            log_step(1, 5, "Installation du package qemu-guest-agent", "Installation")
            success, message = self.proxmox_handler.install_qemu_agent_package_only(vm_info, ssh_credentials)
            
            if not success:
                log_error(f"√âchec installation package: {message}", "Installation")
                return False, f"√âchec installation package: {message}"
            
            log_success("Package qemu-guest-agent install√©", "Installation")
            
            # √âTAPE 2: Activation dans Proxmox
            log_step(2, 5, "Activation QEMU Guest Agent dans Proxmox", "Installation")
            if not self.proxmox_handler.enable_qemu_agent_in_config(node_name, vmid):
                log_error("Impossible d'activer l'agent dans la configuration Proxmox", "Installation")
                return False, "Impossible d'activer l'agent dans la configuration Proxmox"
            
            log_success("Agent activ√© dans la config Proxmox", "Installation")
            
            # √âTAPE 3: Red√©marrage avec m√©thode robuste
            log_step(3, 5, "Red√©marrage √† froid de la VM", "Installation")
            log_info("‚ö†Ô∏è La VM sera temporairement indisponible", "Installation")
            
            restart_success, restart_message = self.restart_vm_robust(node_name, vmid, vm_name)
            
            if not restart_success:
                log_error(f"√âchec red√©marrage: {restart_message}", "Installation")
                return False, f"√âchec red√©marrage: {restart_message}"
            
            log_success("Red√©marrage √† froid r√©ussi", "Installation")
            
            # √âTAPE 4: D√©marrage du service
            log_step(4, 5, "D√©marrage du service qemu-guest-agent", "Installation")
            log_info("Attente stabilisation de la VM...", "Installation")
            time.sleep(10)  # Attendre que la VM soit stable
            
            service_success, service_message = self.proxmox_handler.start_qemu_agent_service(vm_info, ssh_credentials)
            
            if not service_success:
                log_error(f"Service non d√©marr√©: {service_message}", "Installation")
                return False, f"Service non d√©marr√©: {service_message}"
            
            log_success("Service qemu-guest-agent d√©marr√©", "Installation")
            
            # √âTAPE 5: V√©rification finale
            log_step(5, 5, "V√©rification finale", "Installation")
            log_info("Test de l'agent QEMU...", "Installation")
            time.sleep(5)
            
            try:
                self.proxmox_handler.proxmox.nodes(node_name).qemu(vmid).agent.ping.post()
                log_success("Agent QEMU r√©pond correctement", "Installation")
                log_vm("Installation QEMU Agent compl√®tement r√©ussie", vm_name)
                return True, f"Installation compl√®te et agent fonctionnel sur {vm_name}"
            except Exception as e:
                log_info(f"Agent pas encore pr√™t: {str(e)}", "Installation")
                log_vm("Installation termin√©e, agent en cours d'initialisation", vm_name)
                return True, f"Installation termin√©e sur {vm_name}. L'agent devrait √™tre fonctionnel (v√©rifiez dans quelques minutes)."
                
        except Exception as e:
            log_error(f"Erreur dans la s√©quence d'installation: {str(e)}", "Installation")
            return False, f"Erreur installation: {str(e)}"
    
    def restart_vm_robust(self, node_name, vmid, vm_name):
        """Red√©marrage robuste avec gestion des erreurs et logging d√©taill√©"""
        log_vm("D√©but red√©marrage robuste", vm_name)
        
        try:
            import time
            
            # Tentative d'arr√™t
            log_info(f"üîÑ Arr√™t de {vm_name}...", "Installation")
            
            shutdown_success, shutdown_message = self.proxmox_handler.shutdown_vm_robust(node_name, vmid, vm_name)
            if not shutdown_success:
                log_error(f"√âchec arr√™t: {shutdown_message}", "Installation")
                return False, shutdown_message
            
            log_success(f"‚úÖ {vm_name} arr√™t√©e", "Installation")
            
            # Petit d√©lai pour s'assurer que l'arr√™t est complet
            log_info("Pause s√©curit√© avant red√©marrage...", "Installation")
            time.sleep(3)
            
            # Red√©marrage
            log_info(f"üöÄ D√©marrage de {vm_name}...", "Installation")
            
            start_success, start_message = self.proxmox_handler.start_vm_robust(node_name, vmid, vm_name)
            if not start_success:
                log_error(f"√âchec d√©marrage: {start_message}", "Installation")
                return False, start_message
            
            log_success(f"‚úÖ {vm_name} d√©marr√©e", "Installation")
            log_vm("Red√©marrage √† froid termin√© avec succ√®s", vm_name)
            return True, f"Red√©marrage r√©ussi"
            
        except Exception as e:
            log_error(f"Erreur red√©marrage robuste: {str(e)}", "Installation")
            return False, f"Erreur red√©marrage: {str(e)}"

class QemuAgentManagerDialog(QDialog):
    def __init__(self, parent=None, proxmox_handler=None):
        super().__init__(parent)
        self.proxmox_handler = proxmox_handler
        self.setWindowTitle("Gestionnaire QEMU Agent")
        self.resize(800, 500)  # R√©duit car plus de zone de logs
        self.ssh_credentials = {}
        self.install_threads = []
        self.init_ui()
        self.load_vms_status()

    def init_ui(self):
        layout = QVBoxLayout()
        
        # === HEADER ===
        header_label = QLabel("üîß Gestionnaire QEMU Agent")
        header_font = QFont()
        header_font.setPointSize(16)
        header_font.setBold(True)
        header_label.setFont(header_font)
        layout.addWidget(header_label)
        
        desc_label = QLabel("G√©rez l'installation et l'activation de QEMU Agent sur vos VMs")
        desc_label.setStyleSheet("color: #6c757d; margin-bottom: 15px;")
        layout.addWidget(desc_label)
        
        # Info sur les logs
        logs_info = QLabel("üìã Les logs d√©taill√©s s'affichent en temps r√©el dans l'onglet 'Export Projet'")
        logs_info.setStyleSheet("""
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
            margin-bottom: 15px;
        """)
        layout.addWidget(logs_info)
        
        # === TABLEAU DES VMs ===
        self.vm_table = QTableWidget()
        self.vm_table.setColumnCount(6)
        self.vm_table.setHorizontalHeaderLabels([
            "VM", "OS", "√âtat", "Agent Activ√©", "Agent Fonctionne", "Actions"
        ])
        self.vm_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        layout.addWidget(self.vm_table)
        
        # === CONTR√îLES ===
        controls_group = QGroupBox("Actions")
        controls_layout = QHBoxLayout()
        
        self.refresh_btn = QPushButton("üîÑ Actualiser")
        self.refresh_btn.clicked.connect(self.load_vms_status)
        controls_layout.addWidget(self.refresh_btn)
        
        self.install_selected_btn = QPushButton("‚ö° Installer sur s√©lectionn√©es")
        self.install_selected_btn.clicked.connect(self.install_on_selected)
        controls_layout.addWidget(self.install_selected_btn)
        
        self.auto_fix_btn = QPushButton("üöÄ Auto-r√©parer tout")
        self.auto_fix_btn.clicked.connect(self.auto_fix_all)
        controls_layout.addWidget(self.auto_fix_btn)
        
        controls_layout.addStretch()
        controls_group.setLayout(controls_layout)
        layout.addWidget(controls_group)
        
        # === PROGRESSION SIMPLIFI√âE ===
        progress_group = QGroupBox("Progression")
        progress_layout = QVBoxLayout()
        
        self.progress_bar = QProgressBar()
        self.progress_bar.setVisible(False)
        progress_layout.addWidget(self.progress_bar)
        
        # Message d'√©tat simple
        self.status_label = QLabel("Pr√™t")
        self.status_label.setStyleSheet("color: #6c757d; font-style: italic;")
        progress_layout.addWidget(self.status_label)
        
        progress_group.setLayout(progress_layout)
        layout.addWidget(progress_group)
        
        # === BOUTONS ===
        button_layout = QHBoxLayout()
        
        self.close_btn = QPushButton("Fermer")
        self.close_btn.clicked.connect(self.accept)
        button_layout.addStretch()
        button_layout.addWidget(self.close_btn)
        
        layout.addLayout(button_layout)
        self.setLayout(layout)

    def load_vms_status(self):
        """Charge le statut de toutes les VMs"""
        if not self.proxmox_handler:
            log_error("Aucun handler Proxmox disponible", "QemuAgent")
            return
        
        self.status_label.setText("Analyse des VMs en cours...")
        log_step(1, 2, "Analyse des VMs et statut QEMU Agent", "QemuAgent")
        
        try:
            vms_detailed = self.proxmox_handler.get_all_vms_with_agent_status()
            log_debug(f"R√©cup√©ration de {len(vms_detailed)} VMs depuis Proxmox", "QemuAgent")
            
            self.vm_table.setRowCount(len(vms_detailed))
            
            for row, vm in enumerate(vms_detailed):
                vm_name = vm['name']
                log_debug(f"Traitement VM {vm_name} - OS: {vm['os_type']}, Statut: {vm['status']}", "QemuAgent")
                
                # Nom de la VM
                name_item = QTableWidgetItem(vm_name)
                self.vm_table.setItem(row, 0, name_item)
                
                # OS
                os_text = vm['os_type'].title() if vm['os_type'] != 'unknown' else "‚ùì Inconnu"
                os_item = QTableWidgetItem(os_text)
                self.vm_table.setItem(row, 1, os_item)
                
                # √âtat
                status_text = "üü¢ D√©marr√©e" if vm['status'] == 'running' else "üî¥ Arr√™t√©e"
                status_item = QTableWidgetItem(status_text)
                self.vm_table.setItem(row, 2, status_item)
                
                # Agent activ√©
                enabled_text = "‚úÖ Oui" if vm['agent_enabled'] else "‚ùå Non"
                enabled_item = QTableWidgetItem(enabled_text)
                self.vm_table.setItem(row, 3, enabled_item)
                
                # Agent fonctionne
                if vm['status'] != 'running':
                    running_text = "‚è∏Ô∏è VM arr√™t√©e"
                elif vm['agent_running']:
                    running_text = f"‚úÖ Oui (IP: {vm['ip']})"
                    log_debug(f"VM {vm_name} - Agent fonctionnel sur IP {vm['ip']}", "QemuAgent")
                else:
                    running_text = "‚ùå Non"
                    log_debug(f"VM {vm_name} - Agent non fonctionnel", "QemuAgent")
                    
                running_item = QTableWidgetItem(running_text)
                self.vm_table.setItem(row, 4, running_item)
                
                # Bouton d'action
                if vm['can_install_agent'] and vm['status'] == 'running' and not vm['agent_running']:
                    action_btn = QPushButton("üîß Installer + Red√©marrer")
                    action_btn.setStyleSheet("""
                        QPushButton {
                            background-color: #007bff;
                            color: white;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 3px;
                            font-weight: bold;
                        }
                        QPushButton:hover {
                            background-color: #0056b3;
                        }
                    """)
                    action_btn.clicked.connect(lambda checked, v=vm: self.install_single_vm(v))
                    self.vm_table.setCellWidget(row, 5, action_btn)
                    log_debug(f"VM {vm_name} - Bouton d'installation disponible", "QemuAgent")
                else:
                    action_item = QTableWidgetItem("‚úÖ OK" if vm['agent_running'] else "‚ö†Ô∏è Manuel")
                    self.vm_table.setItem(row, 5, action_item)
            
            self.vm_table.resizeColumnsToContents()
            self.status_label.setText(f"Analyse termin√©e - {len(vms_detailed)} VMs trouv√©es")
            log_step(2, 2, f"Analyse termin√©e - {len(vms_detailed)} VMs trouv√©es", "QemuAgent")
            
        except Exception as e:
            self.status_label.setText(f"Erreur: {str(e)}")
            log_error(f"Erreur lors du chargement des VMs: {str(e)}", "QemuAgent")

    def install_single_vm(self, vm_info):
        """Installe QEMU Agent sur une VM sp√©cifique avec red√©marrage automatique"""
        vm_name = vm_info.get('name', 'VM inconnue')
        log_vm(f"D√©but processus d'installation QEMU Agent", vm_name)
        
        # Pour Linux, demander les credentials SSH
        if vm_info['os_type'] == 'linux':
            log_debug("Demande des credentials SSH pour VM Linux", "QemuAgent")
            
            credentials_dialog = SSHCredentialsDialog(self, vm_info)
            if credentials_dialog.exec() != QDialog.DialogCode.Accepted:
                log_info(f"Installation annul√©e par l'utilisateur", "QemuAgent")
                return  # Utilisateur a annul√©
            
            ssh_credentials = credentials_dialog.get_credentials()
            log_debug(f"Credentials SSH obtenus pour {ssh_credentials['username']}@{ssh_credentials['ip']}", "QemuAgent")
            
            # Demander confirmation pour le red√©marrage AVANT de lancer le thread
            log_debug("Demande de confirmation pour le red√©marrage", "QemuAgent")
            
            reply = QMessageBox.question(
                self, 
                "Confirmation installation", 
                f"""Installation compl√®te de QEMU Agent sur {vm_name}

√âTAPES QUI SERONT EFFECTU√âES :
1Ô∏è‚É£ Installation du package qemu-guest-agent
2Ô∏è‚É£ Activation de l'option dans Proxmox  
3Ô∏è‚É£ Red√©marrage √† froid de la VM (arr√™t/d√©marrage)
4Ô∏è‚É£ D√©marrage du service qemu-guest-agent
5Ô∏è‚É£ V√©rification que l'agent fonctionne

‚ö†Ô∏è La VM sera temporairement indisponible pendant le red√©marrage.
üìã Les logs d√©taill√©s s'afficheront dans l'onglet 'Export Projet'

Continuer l'installation ?""",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.Yes
            )
            
            if reply != QMessageBox.StandardButton.Yes:
                log_info(f"Installation annul√©e par l'utilisateur apr√®s confirmation", "QemuAgent")
                return  # Utilisateur a annul√©
            
            log_success(f"Installation confirm√©e par l'utilisateur", "QemuAgent")
        
        else:
            ssh_credentials = None
            log_debug("VM Windows d√©tect√©e - pas de credentials SSH n√©cessaires", "QemuAgent")
        
        self.progress_bar.setVisible(True)
        self.progress_bar.setRange(0, 0)  # Mode ind√©termin√©
        self.status_label.setText(f"Installation en cours sur {vm_name}...")
        
        # D√©sactiver tous les boutons pendant l'installation
        button_count = 0
        for row in range(self.vm_table.rowCount()):
            widget = self.vm_table.cellWidget(row, 5)
            if widget and isinstance(widget, QPushButton):
                widget.setEnabled(False)
                button_count += 1
        
        log_debug(f"D√©sactivation de {button_count} boutons pendant l'installation", "QemuAgent")
        
        # Lancer le thread avec auto_restart=True puisque confirm√©
        log_info(f"Lancement du thread d'installation pour {vm_name}", "QemuAgent")
        thread = QemuAgentInstallThread(self.proxmox_handler, vm_info, ssh_credentials, auto_restart=True)
        thread.installation_complete.connect(self.on_installation_complete)
        self.install_threads.append(thread)
        thread.start()

    def install_on_selected(self):
        """Installe QEMU Agent sur les VMs s√©lectionn√©es"""
        selected_rows = self.vm_table.selectionModel().selectedRows()
        if not selected_rows:
            log_warning("Aucune VM s√©lectionn√©e pour installation group√©e", "QemuAgent")
            QMessageBox.information(self, "S√©lection", "Veuillez s√©lectionner au moins une VM")
            return
        
        log_info(f"{len(selected_rows)} VMs s√©lectionn√©es pour installation group√©e", "QemuAgent")
        # TODO: Impl√©menter l'installation group√©e avec red√©marrage
        QMessageBox.information(self, "En d√©veloppement", 
                              "Fonctionnalit√© en cours de d√©veloppement.\nUtilisez l'installation individuelle en attendant.")

    def auto_fix_all(self):
        """R√©pare automatiquement toutes les VMs qui ont des probl√®mes d'agent"""
        log_info("Tentative de r√©paration automatique de toutes les VMs", "QemuAgent")
        # TODO: Impl√©menter la r√©paration automatique
        QMessageBox.information(self, "En d√©veloppement", 
                              "Fonctionnalit√© en cours de d√©veloppement.\nUtilisez l'installation individuelle en attendant.")

    def on_installation_complete(self, success, message, vm_info):
        """Appel√© quand une installation se termine"""
        vm_name = vm_info.get('name', 'VM inconnue')
        
        self.progress_bar.setVisible(False)
        
        # R√©activer tous les boutons
        button_count = 0
        for row in range(self.vm_table.rowCount()):
            widget = self.vm_table.cellWidget(row, 5)
            if widget and isinstance(widget, QPushButton):
                widget.setEnabled(True)
                button_count += 1
        
        log_debug(f"R√©activation de {button_count} boutons apr√®s installation", "QemuAgent")
        
        if success:
            log_success(f"Installation termin√©e avec succ√®s: {message}", "QemuAgent")
            log_vm("Installation QEMU Agent r√©ussie", vm_name)
            self.status_label.setText(f"Installation r√©ussie sur {vm_name}")
            
            # Actualiser le tableau pour refl√©ter les changements
            log_debug("Actualisation du tableau des VMs", "QemuAgent")
            self.load_vms_status()
        else:
            log_error(f"Installation √©chou√©e: {message}", "QemuAgent")
            log_vm("Installation QEMU Agent √©chou√©e", vm_name)
            self.status_label.setText(f"√âchec installation sur {vm_name}")
        
        # Message de notification
        if success:
            QMessageBox.information(self, "Installation r√©ussie", message)
        else:
            QMessageBox.warning(self, "Installation √©chou√©e", message)

    def closeEvent(self, event):
        """Nettoie les threads lors de la fermeture"""
        log_info("Fermeture du gestionnaire QEMU Agent", "QemuAgent")
        
        active_threads = 0
        for thread in self.install_threads:
            if thread.isRunning():
                thread.terminate()
                thread.wait()
                active_threads += 1
        
        if active_threads > 0:
            log_debug(f"Arr√™t de {active_threads} threads actifs", "QemuAgent")
        
        event.accept()